name: Ubuntu XFCE + Chrome Remote Desktop (335 min)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: >
          Paste raw CRD code (4/0AV...), full command,
          or text containing --code="4/...".
        required: true
      crd_pin:
        description: "CRD PIN (6–12 digits)"
        required: true
        default: "123456"

permissions:
  contents: read

jobs:
  crd:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # ---------- INSTALL XFCE ----------
      - name: Install XFCE desktop
        run: |
          sudo apt update
          sudo apt install -y xfce4 xfce4-goodies dbus-x11

      # ---------- INSTALL CRD ----------
      - name: Install Chrome Remote Desktop
        run: |
          wget -q https://dl.google.com/linux/direct/chrome-remote-desktop_current_amd64.deb
          sudo apt install -y ./chrome-remote-desktop_current_amd64.deb

      # ---------- CONFIGURE XFCE FOR CRD (CORRECT WAY) ----------
      - name: Configure XFCE session
        run: |
          echo "exec xfce4-session" > ~/.chrome-remote-desktop-session
          chmod +x ~/.chrome-remote-desktop-session
          cat ~/.chrome-remote-desktop-session

      # ---------- START CRD ----------
      - name: Start Chrome Remote Desktop
        run: |
          RAW="${{ inputs.crd_code }}"
          PIN="${{ inputs.crd_pin }}"

          if ! [[ "$PIN" =~ ^[0-9]{6,12}$ ]]; then
            echo "Invalid PIN (must be 6–12 digits)"
            exit 1
          fi

          if [[ "$RAW" =~ --code[=[:space:]]*\"?([^\"[:space:]]+) ]]; then
            CODE="${BASH_REMATCH[1]}"
          elif [[ "$RAW" =~ ^4/ ]]; then
            CODE="$RAW"
          else
            echo "Invalid CRD code"
            exit 1
          fi

          echo "Starting Chrome Remote Desktop..."

          /opt/google/chrome-remote-desktop/start-host \
            --code="$CODE" \
            --redirect-url="https://remotedesktop.google.com/_/oauthredirect" \
            --name="$(hostname)" \
            --pin="$PIN"

      # ---------- KEEP ALIVE (335 MIN) ----------
      - name: Keep alive (335 minutes)
        run: |
          MINUTES=335
          echo "Keeping runner alive for $MINUTES minutes"
          END=$((SECONDS + MINUTES*60))

          while [ $SECONDS -lt $END ]; do
            echo "[ALIVE] $(date) — remaining $(( (END-SECONDS)/60 )) min"
            sleep 60
          done
