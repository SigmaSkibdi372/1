name: Chrome Remote Desktop Only (335 min)

on:
  workflow_dispatch:
    inputs:
      crd_code:
        description: >
          Paste raw CRD code (4/0AV...), full PowerShell command,
          or text containing --code="4/...".
        required: true
      crd_pin:
        description: "CRD PIN (6–12 digits)"
        required: true
        default: "123456"

permissions:
  contents: read

defaults:
  run:
    shell: pwsh

jobs:
  crd:
    runs-on: windows-2022
    timeout-minutes: 360

    steps:
      # ---------- INSTALL CRD ----------
      - name: Install Chrome Remote Desktop Host
        run: |
          $exe = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          if (-not (Test-Path $exe)) {
            Write-Host "Installing Chrome Remote Desktop Host..."
            $msi = "$env:TEMP\crd.msi"
            Invoke-WebRequest `
              -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" `
              -OutFile $msi
            Start-Process msiexec.exe -ArgumentList "/i","`"$msi`"","/quiet","/norestart" -Wait
          } else {
            Write-Host "CRD already installed."
          }

      # ---------- START CRD ----------
      - name: Start Chrome Remote Desktop
        run: |
          $raw = @'
          ${{ inputs.crd_code }}
          '@.Trim()

          $pin = "${{ inputs.crd_pin }}".Trim()

          if ($pin -notmatch '^\d{6,12}$') {
            Write-Error "CRD PIN must be 6–12 digits"
            exit 1
          }

          $exe = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"

          if ($raw -match '--code\s*=\s*"?([^"\s]+)') {
            $code = $Matches[1]
          } elseif ($raw -match '^4\/') {
            $code = $raw
          } else {
            Write-Error "Invalid CRD code"
            exit 1
          }

          Write-Host "Launching Chrome Remote Desktop..."

          Start-Process $exe -ArgumentList @(
            "--code=$code",
            "--redirect-url=https://remotedesktop.google.com/_/oauthredirect",
            "--name=$env:COMPUTERNAME",
            "--pin=$pin"
          )

      # ---------- VERIFY SERVICE ----------
      - name: Verify CRD service
        run: |
          $svc = "Chrome Remote Desktop Service"
          Start-Sleep 10
          $s = Get-Service -Name $svc -ErrorAction SilentlyContinue
          if ($s -and $s.Status -in 'Running','StartPending') {
            Write-Host "CRD service running."
          } else {
            Write-Warning "CRD service not running yet."
          }

      # ---------- KEEP ALIVE (335 MIN) ----------
      - name: Keep alive (335 minutes)
        run: |
          $mins = 335
          Write-Host "Keeping runner alive for $mins minutes"

          $end = (Get-Date).AddMinutes($mins)

          while ((Get-Date) -lt $end) {
            Write-Host ("[ALIVE] " + (Get-Date).ToString("HH:mm:ss") +
              " | ends at " + $end.ToString("HH:mm:ss"))
            Start-Sleep -Seconds 60
          }
